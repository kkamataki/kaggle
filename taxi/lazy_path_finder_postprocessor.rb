#!/usr/local/bin/ruby

require './calc_grid.rb'

def calc_long_lat_mean(end_locs)

  long_sum = 0.0
  lat_sum = 0.0

  end_locs.each do |geo_idx|
    longlat = from_grid_to_longlat(geo_idx.to_i)
    long_sum += longlat[:long]
    lat_sum += longlat[:lat]
  end

  return {:long => long_sum/end_locs.size, :lat => lat_sum/end_locs.size}

end

tid_set = []
open("sampleSubmission.csv").each do |x|
  tid = x.split(",")[0]
  tid_set.push(tid) if tid =~ /T\d/
end


f = open(ARGV[1],'w')

f.puts %Q{"TRIP_ID","LATITUDE","LONGITUDE"}

open(ARGV[0]) do |l|

  #skip header
  l.gets

  tid_idx = 0
  #get result for each test item
  l.read.split("\n").each do |x|
    average_long_lat = calc_long_lat_mean(x.split(","))

    f.print tid_set[tid_idx] + ","

    unless average_long_lat[:long].to_s == "NaN"
      f.puts average_long_lat[:lat].to_s + "," + average_long_lat[:long].to_s
    else
      ### When no end matching point was found in the training set, just print out the center of the city geo location
      ### in the sampleSubmission.csv at this moment  (Note: this is a rare case)
      f.puts "41.146504,-8.611317"
    end
    tid_idx += 1

  end

end

#Intersting outlier example (starting from the grid "2474354")
#"2474354,2474353,2470353,2464354,2460352,2456351,2454353,2448354,2444354,2442354,2442355,2442359,2440363,2440367,2438370,2438372,2436373,2440374,2444375,2450377,2456377,2458378,2458379,2456384,2448387,2440392,2432396,2422398,2412399,2402397,2392397,2382394,2374391,2370385,2370380,2374378,2376376,2374375,2368375,2362376,2358376,2360379,2358383,2356387,2352392,2348395,2342396,2336396,2330395,2324395,2314396,2302399,2290398,2282394,2272390,2260391,2250392,2238389,2228388,2220383,2210378,2200375,2188377,2176377,2168372,2162365,2150362,2144356,2138349,2126347,2116343,2108336,2102329,2094322,2084318,2070318,2058320,2046318,2036314,2026311,2014309,2000308,1990310,1984312,1974314,1962313,1950309,1942305,1930302,1918299,1908298,1898294,1888290,1876288,1866285,1856281,1848277,1840274,1832273,1824274,1820275,1818275,1816275,1816274,1816273,1816272,1818271,1818269,1818268,1820267,1820265,1822263,1822262,1820264,1820266,1818266,1816265,1816266,1818266,1818265,1818266,1820266,1818266,1820266,1818266,1820266,1818266,1820266,1818266,1820266,1818266,1820266,1818266,1820266,1818266,1820266,1818266,1820266,1818266,1820266,1818266,1820266,1818266,1820266,1818266,1816265,1816266,1818266,1818265,1818266,1820266,1818268,1818269,1818270,1816272,1814276,1810277,1814276,1822275,1830273,1840274,1848278,1858281,1866285,1876288,1886290,1896294,1906298,1916299,1926302,1938304,1948308,1956312,1966314,1978314,1986312,1994309,2006308,2018310,2028312,2038315,2050319,2062320,2074318,2084319,2094323,2100329,2106335,2114342,2122347,2134349,2144353,2148360,2158364,2166370,2174376,2184378,2196376,2208377,2216382,2224387,2236389,2246391,2258392,2268390,2280392,2288398,2298400,2310398,2320395,2326396,2330397,2336396,2344396,2352396,2354393,2356388,2358382,2360377,2366375,2372375,2376377,2370378,2372377,2370382,2372388,2378393,2388396,2398397,2408398,2418399,2428398,2436394,2446389,2454385,2458379,2460377,2456377,2454377,2450377,2448376,2446376,2444375,2442375,2440374,2438373,2438372,2438370,2438369,2440367,2440365,2440363,2442362,2442360,2442357,2442355,2444354,2448354,2452354,2454351,2458351,2460354,2466353,2470353,2474353,2474354,2474355,2474354".split(",").each do |x|
#  result = from_grid_to_longlat(x.to_i)
#  puts result[:lat].to_s + "," + result[:long].to_s
#end

f.close
